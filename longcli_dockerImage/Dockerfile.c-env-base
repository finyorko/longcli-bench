FROM ghcr.io/laude-institute/t-bench/ubuntu-24-04:20250624

RUN apt-get update && apt-get upgrade -y && \
    apt-get install -y --no-install-recommends \
    git \
    build-essential \
    gcc \
    g++ \
    make \
    cmake \
    clang-15 \
    clang-format-15 \
    clang-tidy-15 \
    doxygen \
    pkg-config \
    zlib1g-dev \
    libelf-dev \
    libdwarf-dev \
    openssh-server \
    sudo \
    rsync \
    gdb-multiarch \
    qemu-system-misc \
    gcc-riscv64-linux-gnu \
    binutils-riscv64-linux-gnu \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*
    
RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*

RUN curl -LsSf https://astral.sh/uv/0.7.13/install.sh | sh
ENV PATH="/root/.local/bin:${PATH}"

WORKDIR /opt/pytest-proj
RUN uv init -q && uv add pytest==8.4.1 && uv run -q python -c "import importlib.metadata as im; print(im.version('pytest'))"

# ===================== Install Google Test =====================
WORKDIR /usr/src/libraries
RUN git clone --depth=1 -b main https://github.com/google/googletest.git && \
    cd googletest && \
    mkdir -p build && \
    cd build && \
    cmake .. && \
    make -j$(nproc) && \
    make install && \
    cd / && \
    rm -rf /usr/src/libraries
# ===================== Google Test Install Finished =====================

WORKDIR /app

ARG NODE_VERSION=22
ARG CODEX_VERSION=0.98.0
ARG CLAUDE_VERSION=2.1.34
ARG GEMINI_VERSION=0.22.4

ENV NVM_DIR=/root/.nvm

# Use bash so nvm scripts source correctly
SHELL ["/bin/bash", "-o", "pipefail", "-c"]

RUN rm -rf /app/docker_data
# RUN rm -rf /app/util

RUN apt-get update \
 && apt-get install -y --no-install-recommends curl ca-certificates \
 && rm -rf /var/lib/apt/lists/* \
 # Install nvm
 && curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.2/install.sh | bash \
 # Load nvm and install Node.js
 && source "$NVM_DIR/nvm.sh" \
 && nvm install ${NODE_VERSION} \
 && npm -v \
 # Install Codex CLI globally
 && npm config set fund false \
 && npm config set update-notifier false \
 && npm install -g @openai/codex@${CODEX_VERSION} \
 && npm install -g @anthropic-ai/claude-code@${CLAUDE_VERSION} \
 && npm install -g @google/gemini-cli@${GEMINI_VERSION} \
 && mkdir -p "$HOME/.codex" \
 && mkdir -p "$HOME/.claude" \
 # Ensure codex is on PATH for non-login shells
 && ln -sf "$(npm prefix -g)/bin/codex" /usr/local/bin/codex \
 # Smoke test (no network)
 && codex --help >/dev/null 2>&1 || true

# RUN apt update && apt install -y make && rm -rf /var/lib/apt/lists/*
# mod

WORKDIR /app

