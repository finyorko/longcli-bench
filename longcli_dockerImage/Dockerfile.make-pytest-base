FROM ghcr.io/laude-institute/t-bench/ubuntu-24-04:20250624

RUN apt-get update && apt-get upgrade -y && \
    apt-get install -y \
    git \
    build-essential \
    gdb-multiarch \
    qemu-system-misc \
    gcc-riscv64-linux-gnu \
    binutils-riscv64-linux-gnu \
    make
    
RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*

RUN curl -LsSf https://astral.sh/uv/0.7.13/install.sh | sh
ENV PATH="/root/.local/bin:${PATH}"

WORKDIR /opt/pytest-proj
RUN uv init -q && uv add pytest==8.4.1 && uv run -q python -c "import importlib.metadata as im; print(im.version('pytest'))"

WORKDIR /app

ARG NODE_VERSION=22

ENV NVM_DIR=/root/.nvm

# Use bash so nvm scripts source correctly
SHELL ["/bin/bash", "-o", "pipefail", "-c"]

RUN rm -rf /app/docker_data
# RUN rm -rf /app/util

RUN apt-get update \
 && apt-get install -y --no-install-recommends curl ca-certificates \
 && rm -rf /var/lib/apt/lists/* \
 # Install nvm
 && curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.2/install.sh | bash \
 # Load nvm and install Node.js
 && source "$NVM_DIR/nvm.sh" \
 && nvm install ${NODE_VERSION} \
 && npm -v \
 && npm config set fund false \
 && npm config set update-notifier false
